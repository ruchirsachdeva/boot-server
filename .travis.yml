sudo: required
dist: trusty
language: java
jdk:
- oraclejdk8
cache:
  directories:
  - '$HOME/.m2/repository'

script: mvn clean test -Dspring.profiles.active=test

before_deploy:
  - sudo apt-get -y install python-pip
  - sudo pip install awscli
  - export ENV=$(echo "${TRAVIS_BRANCH}" | perl -ne "print $& if /(?<=deploy\/).*/")
  - scripts/create-archives.sh
deploy:
  # upload jar and codedeploy scripts
  - provider: s3
    bucket: deploy-${ENV}.hana053.com
    region: ${AWS_DEFAULT_REGION}
    local_dir: .deploy
    upload-dir: micropost
    skip_cleanup: true
    on:
      branch: deploy/*
  # deploy by using codedeploy
  - provider: codedeploy
    bucket: deploy-${ENV}.hana053.com
    region: ${AWS_DEFAULT_REGION}
    key: micropost/codedeploy.tar.gz
    application: micropost-${ENV}
    deployment_group: web
    bundle_type: tgz
    on:
      branch: deploy/*

